{% extends "base.html" %}

{% block title %}Dashboard - Smart Study Planner{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1 class="page-title">üìä Your Dashboard</h1>
        <p class="page-subtitle">{{ today.strftime('%A, %B %d, %Y') }}</p>
    </div>
    
    <!-- Quick Stats -->
    <div class="grid grid-cols-4 mb-3">
        <div class="card">
            <div class="stat-item">
                <div class="stat-value">{{ progress.completion_percentage }}%</div>
                <div class="stat-label">Overall Progress</div>
            </div>
        </div>
        
        <div class="card">
            <div class="stat-item">
                <div class="stat-value">{{ streak }}</div>
                <div class="stat-label">Day Streak üî•</div>
            </div>
        </div>
        
        <div class="card">
            <div class="stat-item">
                <div class="stat-value">{{ today_sessions|length }}</div>
                <div class="stat-label">Today's Sessions</div>
            </div>
        </div>
        
        <div class="card">
            <div class="stat-item">
                <div class="stat-value">{{ backlog|length }}</div>
                <div class="stat-label">Backlog Items</div>
            </div>
        </div>
    </div>
    
    <div class="grid grid-cols-3">
        <!-- Today's Sessions -->
        <div style="grid-column: span 2;">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Today's Study Sessions</h2>
                </div>
                
                {% if today_sessions %}
                    {% for block in ['Morning', 'Afternoon', 'Evening'] %}
                        {% if block in sessions_by_block %}
                            <h3 style="font-size: 1.1rem; font-weight: 600; margin: 1.5rem 0 1rem; color: var(--text-primary);">
                                {{ block }}
                            </h3>
                            
                            {% for session in sessions_by_block[block] %}
                                {% set subject_color = session.subject.color if session.subject else '#3B82F6' %}
                                <div class="session-card session-status-{{ session.status }}" style="border-left-color: {{ subject_color }};">
                                    <div class="session-header">
                                        <div>
                                            <div class="session-subject" style="color: {{ subject_color }};">
                                                {{ session.subject.name if session.subject else 'Unknown Subject' }}
                                            </div>
                                            <div class="session-topic">
                                                {{ session.topic.title if session.topic else 'Unknown Topic' }}
                                            </div>
                                        </div>
                                        
                                        <div>
                                            {% if session.status == 'completed' %}
                                                <span class="badge badge-success">‚úì Completed</span>
                                            {% elif session.status == 'skipped' %}
                                                <span class="badge badge-warning">‚è≠ Skipped</span>
                                            {% else %}
                                                <span class="badge badge-info">‚è≥ Pending</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <div class="session-meta">
                                        <span>‚è± {{ session.planned_minutes }} min</span>
                                        <span>üìÖ {{ block }}</span>
                                        {% if session.notes %}
                                            <span>üìù {{ session.notes }}</span>
                                        {% endif %}
                                    </div>
                                    
                                    {% if session.status == 'pending' %}
                                        <div class="session-actions">
                                            <form method="POST" action="{{ url_for('planner.complete_session', session_id=session._id) }}" style="display: inline;">
                                                <button type="submit" class="btn btn-success btn-sm">‚úì Complete</button>
                                            </form>
                                            
                                            <form method="POST" action="{{ url_for('planner.skip_session', session_id=session._id) }}" style="display: inline;">
                                                <button type="submit" class="btn btn-secondary btn-sm">‚è≠ Skip</button>
                                            </form>
                                            
                                            {% set date_str = today.strftime('%Y-%m-%d') %}
                                            <button onclick="rescheduleSession('{{ session._id }}', '{{ date_str }}')" class="btn btn-secondary btn-sm">
                                                ‚Üª Reschedule
                                            </button>
                                        </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÖ</div>
                        <p class="empty-state-text">No sessions scheduled for today</p>
                        <a href="{{ url_for('planner.planner') }}" class="btn btn-primary">Generate Study Plan</a>
                    </div>
                {% endif %}
            </div>
            
            <!-- Backlog -->
            {% if backlog %}
                <div class="card mt-3">
                    <div class="card-header">
                        <h2 class="card-title">Backlog (Skipped Sessions)</h2>
                    </div>
                    
                    {% for session in backlog[:5] %}
                        {% set backlog_color = session.subject.color if session.subject else '#F59E0B' %}
                        <div class="session-card session-status-skipped" style="border-left-color: {{ backlog_color }};">
                            <div class="session-header">
                                <div>
                                    <div class="session-subject">
                                        {{ session.subject.name if session.subject else 'Unknown Subject' }}
                                    </div>
                                    <div class="session-topic">
                                        {{ session.topic.title if session.topic else 'Unknown Topic' }}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="session-meta">
                                <span>‚è± {{ session.planned_minutes }} min</span>
                                <span>üìÖ Originally: {{ session.date.strftime('%b %d') }}</span>
                            </div>
                            
                            <div class="session-actions">
                                {% set date_str = today.strftime('%Y-%m-%d') %}
                                <button onclick="rescheduleSession('{{ session._id }}', '{{ date_str }}')" class="btn btn-primary btn-sm">
                                    ‚Üª Reschedule
                                </button>
                            </div>
                        </div>
                    {% endfor %}
                    
                    {% if backlog|length > 5 %}
                        <p class="text-center mt-2" style="color: var(--text-muted);">
                            And {{ backlog|length - 5 }} more...
                        </p>
                    {% endif %}
                </div>
            {% endif %}
        </div>
        
        <!-- Sidebar -->
        <div>
            <!-- This Week -->
            <div class="card mb-3">
                <div class="card-header">
                    <h3 class="card-title">This Week</h3>
                </div>
                
                {% for day in week_sessions %}
                    {% set day_bg_color = 'var(--bg-hover)' if day.is_today else 'transparent' %}
                    {% set day_text_color = 'var(--success-color)' if (day.completed == day.total and day.total > 0) else 'var(--text-primary)' %}
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-bottom: 1px solid var(--border-color); background-color: {{ day_bg_color }};">
                        <div>
                            <div style="font-weight: 600;">{{ day.day_name }}</div>
                            <div style="font-size: 0.875rem; color: var(--text-muted);">{{ day.date.strftime('%b %d') }}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: 600; color: {{ day_text_color }};">
                                {{ day.completed }}/{{ day.total }}
                            </div>
                            <div style="font-size: 0.875rem; color: var(--text-muted);">sessions</div>
                        </div>
                    </div>
                {% endfor %}
            </div>
            
            <!-- Upcoming Exams -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Upcoming Exams</h3>
                </div>
                
                {% if upcoming_exams %}
                    {% for exam in upcoming_exams %}
                        {% set exam_urgency_color = 'var(--error-color)' if exam.days_left <= 7 else ('var(--warning-color)' if exam.days_left <= 14 else 'var(--success-color)') %}
                        <div style="padding: 0.75rem; border-bottom: 1px solid var(--border-color);">
                            <div style="font-weight: 600; color: {{ exam.color }};">
                                {{ exam.name }}
                            </div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.25rem;">
                                üìÖ {{ exam.exam_date.strftime('%b %d, %Y') }}
                            </div>
                            <div style="font-size: 0.875rem; font-weight: 600; color: {{ exam_urgency_color }}; margin-top: 0.25rem;">
                                {{ exam.days_left }} days left
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <p>No upcoming exams</p>
                        <a href="{{ url_for('subjects.list_subjects') }}" class="btn btn-sm btn-primary">Add Subjects</a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Reschedule Modal Form (Hidden by default) -->
<div id="reschedule_form" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 8px; box-shadow: var(--shadow-lg); z-index: 1000;">
    <h3 style="margin-bottom: 1rem;">Reschedule Session</h3>
    <form method="POST" action="" id="reschedule_form_element">
        <input type="hidden" id="reschedule_session_id" name="session_id">
        
        <div class="form-group">
            <label for="reschedule_new_date" class="form-label">New Date</label>
            <input type="date" id="reschedule_new_date" name="new_date" class="form-input" required>
        </div>
        
        <div class="form-group">
            <label for="reschedule_new_block" class="form-label">New Block</label>
            <select id="reschedule_new_block" name="new_block" class="form-select" required>
                <option value="Morning">Morning</option>
                <option value="Afternoon">Afternoon</option>
                <option value="Evening">Evening</option>
            </select>
        </div>
        
        <div style="display: flex; gap: 0.5rem;">
            <button type="submit" class="btn btn-primary">Reschedule</button>
            <button type="button" class="btn btn-secondary" onclick="document.getElementById('reschedule_form').style.display='none'">Cancel</button>
        </div>
    </form>
</div>

<script>
function rescheduleSession(sessionId, currentDate) {
    document.getElementById('reschedule_session_id').value = sessionId;
    document.getElementById('reschedule_new_date').value = currentDate;
    document.getElementById('reschedule_form').style.display = 'block';
    
    // Update form action
    document.getElementById('reschedule_form_element').action = `/sessions/${sessionId}/reschedule`;
}
</script>
{% endblock %}
